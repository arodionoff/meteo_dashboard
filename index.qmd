---
title: "Using {openmeteo} package with Quarto dashboard"
author: 
  name: Alexander Rodionov
  email: a.rodionoff@gmail.com
  roles: "Ph.D., Data Scientist"
date_start: "7 November 2024"
# orientation: columns
params:
  # loc_name:  'Almaty City' # 'Phuquoc Island'
  # loc_code:  'ALA' # 'PQC'
  # loc_coordinats: !expr "c('latitude' = 43.25, 'longitude' = 76.93)"  # "c('latitude' = 10.2872, 'longitude' = 104.0105)"
  # loc_name: 'Phuquoc Island'  # 'Almaty City' 
  # loc_code:  'PQC'# 'ALA'
  # loc_coordinats: !expr "c('latitude' = 10.2872, 'longitude' = 104.0105)"  # "c('latitude' = 43.25, 'longitude' = 76.93)"
  loc_name:  'Oymyakon Vilage'
  loc_code:  'OYM'
  loc_coordinats: !expr "c('latitude' = 63.4622, 'longitude' = 142.7949)"
  # loc_name:  'Dubai City'
  # loc_code:  'DXB'
  # loc_coordinats: !expr "c('latitude' = 25.0772, 'longitude' = 55.3093)"  Start_Date:  1994-11-01
  Finish_Date: 2024-11-01
---

```{r}
#| label: setup
#| include: false
# Global options

# https://www.meteoblue.com/ru/%D0%BF%D0%BE%D0%B3%D0%BE%D0%B4%D0%B0/historyclimate/climatemodelled/%d0%90%d0%bb%d0%bc%d0%b0%d1%82%d1%8b_%d0%9a%d0%b0%d0%b7%d0%b0%d1%85%d1%81%d1%82%d0%b0%d0%bd_1526384

# https://open-meteo.com/en/docs/historical-weather-api#latitude=63.4622&longitude=142.7949&start_date=2020-01-01&end_date=2024-09-15&hourly=&daily=weather_code,temperature_2m_max,temperature_2m_min,temperature_2m_mean,apparent_temperature_max,apparent_temperature_min,apparent_temperature_mean,sunrise,sunset,daylight_duration,sunshine_duration,precipitation_sum,rain_sum,snowfall_sum,precipitation_hours,wind_speed_10m_max,wind_gusts_10m_max,wind_direction_10m_dominant,shortwave_radiation_sum,et0_fao_evapotranspiration&timezone=auto
```

# Overview

```{r}
#| label: Libraries

library('ggplot2')          # Create Elegant Data Visualisations Using the Grammar of Graphics
library('dplyr')            # A Grammar of Data Manipulation 
library('purrr')            # Functional Programming Tools
library('tibble')           # Simple Data Frames
library('lubridate')        # Dates and times made easy with lubridate
library('tidyr')            # Tidy Messy Data 
library('arrow')            # Integration to 'Apache' 'Arrow'
library('rlang')            # Functions for Base Types and Core R and 'Tidyverse' Features
library('forcats')          # Tools for Working with Categorical Variables (Factors)
library('janitor')          # Simple Tools for Examining and Cleaning Dirty Data
library('DT')               # A Wrapper of the JavaScript Library 'DataTables'
library('leaflet')          # Create Interactive Web Maps with the JavaScript 'Leaflet' Library 

# devtools::install_github('tpisel/openmeteo')
library('openmeteo')        # Retrieve Weather Data from the Open-Meteo API

Subtitle <- 
  paste0(params$loc_name, " (", round(params$loc_coordinats['latitude'], digi = 2), ifelse(params$loc_coordinats['latitude'] > 0, "°N Lat, ",  "°S Lat, "), round(params$loc_coordinats['longitude'], digi = 2), ifelse(params$loc_coordinats['longitude'] > 0, "°E Lng)", "°W Lng)"))

```

---
subtitle: "for **`r Subtitle`** by"
---

```{r}
#| label: Meteo Dictionaries

# WMO CODE TABLE 4677 - https://www.nodc.noaa.gov/archive/arc0021/0002199/1.1/data/0-data/HTML/WMO-CODE/WMO4677.HTM

WCO_Codes_tbl <- 
  tibble::tribble( ~`weather_code`, ~Weather,
    # Текущая погода
    0, 'Развитие облаков не наблюдается или не наблюдается (Характерное изменение состояния неба за последний час)',
    1, 'Облака в целом рассеиваются или становятся менее развитыми (Характерное изменение состояния неба за последний час)',
    2, 'Состояние неба в целом не изменилось. (Характерное изменение состояния неба за последний час)',
    3, 'Облака, как правило, формируются или развиваются (Характерное изменение состояния неба за последний час)',
    4, 'Видимость снижена из-за дыма, например, от лесных пожаров, промышленного дыма или вулканического пепла.',
    5, 'Туман',
    6, 'Широко распространенная пыль, взвешенная в воздухе, не поднятая ветром на станции или вблизи нее во время наблюдения.',
    7, 'Пыль или песок, поднятые ветром на станции или около нее во время наблюдения, но не было хорошо развитых пылевых или песчаных вихрей, а также не наблюдалось пыльной или песчаной бури.',
    8, 'Хорошо развитые пылевые вихри или песчаные вихри, наблюдавшиеся на станции или вблизи нее в течение предыдущего часа или во время наблюдения, но без пыльной или песчаной бури',
    9, 'Пыльная или песчаная буря в пределах видимости во время наблюдения или на станции в течение предыдущего часа',
    10, 'Туман',
    11, 'Патчи (мелкий туман или ледяной туман на станции, будь то на суше или на море, не глубже примерно 2 метров на суше или 10 метров на море)',
    12, 'Более или менее непрерывный (мелкий туман или ледяной туман на станции, будь то на суше или на море, не глубже примерно 2 метров на суше или 10 метров на море)',
    13, 'Молния видна, грома не слышно',
    14, 'Осадки в пределах видимости, не достигающие земли или поверхности моря',
    15, 'Осадки в пределах видимости, достигающие земли или поверхности моря, но удаленные, т.е. по оценкам, находящиеся на расстоянии более 5 км от станции',
    16, 'Осадки в пределах видимости, достигающие земли или поверхности моря, вблизи станции, но не на ней',
    17, 'Гроза, но на момент наблюдения осадков не было',
    18, 'Шквалы (на станции или в пределах ее видимости в течение предыдущего часа или во время наблюдения)',
    19, 'Воронкообразное облако(а) ** (на станции или в пределах ее видимости в течение предыдущего часа или во время наблюдения)',
    # Осадки, туман, ледяной туман или гроза на станции в течение предыдущего часа, но не в момент наблюдения
    20, 'Морось (не замерзающая) или снежные зерна (не падает как ливень(и))',
    21, 'Дождь (не замерзающий) (не падает как ливень(и))',
    22, 'Снег (не падает как ливень(и))',
    23, 'Дождь и снег или ледяная крупа (не падает как ливень(и))',
    24, 'Замерзающая морось или ледяной дождь (не падает как ливень(и))',
    25, 'Ливень(и) дождя',
    26, 'Снегопад или дождь со снегом',
    27, 'Ливень(и) града * или дождя с градом *',
    28, 'Туман или ледяной туман',
    29, 'Гроза (с осадками или без них)',
    # Пыльная буря, песчаная буря, метель или снежная метель
    30, 'Небольшая или умеренная пыльная или песчаная буря (- уменьшилось в течение предыдущего часа)',
    31, 'Небольшая или умеренная пыльная или песчаная буря (- никаких существенных изменений в течение предыдущего часа)',
    32, 'Небольшая или умеренная пыльная или песчаная буря (- началось или усилилось в течение предыдущего часа)',
    33, 'Сильная пыльная или песчаная буря (- уменьшилось в течение предыдущего часа)',
    34, 'Сильная пыльная или песчаная буря (- никаких существенных изменений в течение предыдущего часа)',
    35, 'Сильная пыльная или песчаная буря (- началось или усилилось в течение предыдущего часа)',
    36, 'Слабая или умеренная метель (обычно низкий (ниже уровня глаз))',
    37, 'Сильный снежный поземок (обычно низкий (ниже уровня глаз))',
    38, 'Слабая или умеренная метель (обычно высокий (выше уровня глаз))',
    39, 'Сильный снежный поземок (обычно высокий (выше уровня глаз))',
    # Туман или ледяной туман во время наблюдения
    40, 'Туман или ледяной туман на расстоянии во время наблюдения, но не на станции в течение предыдущего часа, причем туман или ледяной туман распространяется на уровень выше уровня наблюдателя',
    41, 'Туман или ледяной туман местами',
    42, 'Туман или ледяной туман, небо видно (стал тоньше в течение предыдущего часа)',
    43, 'Туман или ледяной туман, небо не видно (стал тоньше в течение предыдущего часа)',
    44, 'Туман или ледяной туман, небо видно (никаких существенных изменений в течение предыдущего часа)',
    45, 'Туман или ледяной туман, небо не видно (никаких существенных изменений в течение предыдущего часа)',
    46, 'Туман или ледяной туман, небо видно (начался или стал гуще в течение предыдущего часа)',
    47, 'Туман или ледяной туман, небо не видно (начался или стал гуще в течение предыдущего часа)',
    48, 'Туман, налипает изморозь, небо видно',
    49, 'Туман, налипающий иней, небо невидимо',
    # Морось
    50, 'Морось, не замерзающая, кратковременная (незначительный во время наблюдения)',
    51, 'Морось, не замерзающая, непрерывная (незначительный во время наблюдения)',
    52, 'Морось, не замерзающая, кратковременная (умеренный на момент наблюдения)',
    53, 'Морось, не замерзающая, непрерывная (умеренный на момент наблюдения)',
    54, 'Морось, не замерзающая, кратковременная (сильный на момент наблюдения)',
    55, 'Морось, не замерзающая, непрерывная (сильный на момент наблюдения)',
    56, 'Морось, замерзающая, слабая',
    57, 'Морось, замерзающая, умеренная или сильная (густая)',
    58, 'Морось и дождь, слабый',
    59, 'Морось и дождь, умеренный или сильный',
    # Дождь
    60, 'Дождь, не замерзающий, кратковременный (незначительный во время наблюдения)',
    61, 'Дождь, не замерзающий, непрерывный (незначительный во время наблюдения)',
    62, 'Дождь, не замерзающий, кратковременный (умеренный на момент наблюдения)',
    63, 'Дождь, не замерзающий, непрерывный (умеренный на момент наблюдения)',
    64, 'Дождь, не замерзающий, кратковременный (тяжелый во время наблюдения)',
    65, 'Дождь, не замерзающий, непрерывный (тяжелый во время наблюдения)',
    66, 'Дождь, морозный, слабый',
    67, 'Дождь, замерзающий, умеренный или сильный (плотный)',
    68, 'Дождь или морось со снегом, слабый',
    69, 'Дождь или морось со снегом, умеренный или сильный',
    # Твердые осадки без ливней
    70, 'Прерывистое падение снежинок (незначительный во время наблюдения)',
    71, 'Непрерывное падение снежинок (незначительный во время наблюдения)',
    72, 'Прерывистое падение снежинок (умеренный на момент наблюдения)',
    73, 'Непрерывное падение снежинок (умеренный на момент наблюдения)',
    74, 'Прерывистое падение снежинок (тяжелый во время наблюдения)',
    75, 'Непрерывное падение снежинок (тяжелый во время наблюдения)',
    76, 'Алмазная пыль (с туманом или без него)',
    77, 'Снежные зерна (с туманом или без него)',
    78, 'Изолированные снежные кристаллы в форме звезд (с туманом или без него)',
    79, 'Ледяные гранулы',
    # Ливневые осадки или осадки с текущей или недавней грозой
    80, 'Ливневый дождь(ы), слабый',
    81, 'Ливневый(ые) дождь(и), умеренный или сильный',
    82, 'Ливень(и), сильный',
    83, 'Ливень(и) со снегом, слабый',
    84, 'Ливень(и) со снегом, смешанный, умеренный или сильный',
    85, 'Снежный ливень(и), небольшой',
    86, 'Снегопад(ы), умеренный или сильный',
    87, 'Ливень(и) в виде снежной крупы или мелкого града, с дождем или без него, или смешанный с дождем и снегом (- небольшой)',
    88, 'Ливень(и) в виде снежной крупы или мелкого града, с дождем или без него, или смешанный с дождем и снегом (- умеренный или тяжелый)',
    89, 'Ливень(и) града * , с дождем или без него или смешанный с дождем и снегом, не связанный с грозой (- небольшой)',
    90, 'Ливень(и) града * , с дождем или без него или смешанный с дождем и снегом, не связанный с грозой (- умеренный или тяжелый)',
    91, 'Небольшой дождь во время наблюдения (Гроза в течение предыдущего часа, но не в момент наблюдения)',
    92, 'Умеренный или сильный дождь во время наблюдения (Гроза в течение предыдущего часа, но не в момент наблюдения)',
    93, 'Небольшой снег или дождь со снегом или град ** во время наблюдения (Гроза в течение предыдущего часа, но не в момент наблюдения)',
    94, 'Умеренный или сильный снег, или дождь со снегом или град ** во время наблюдения (Гроза в течение предыдущего часа, но не в момент наблюдения)',
    95, 'Гроза слабая или умеренная, без града **, но с дождем и/или снегом в момент наблюдения (Гроза во время наблюдения)',
    96, 'Гроза слабая или умеренная с градом ** в момент наблюдения (Гроза во время наблюдения)',
    97, 'Гроза сильная, без града **, но с дождем и/или снегом в момент наблюдения (Гроза во время наблюдения)',
    98, 'Гроза в сочетании с пыльной или песчаной бурей во время наблюдения (Гроза во время наблюдения)',
    99, 'Гроза сильная с градом ** в момент наблюдения (Гроза во время наблюдения)',
    )

# Oceanic Niño Index - https://origin.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ONI_v5.php
ONI_tbl <- tibble::tribble(
  ~`Start Month`, ~`Finish Month`, ~Conditions,
  "2000-01-01", "2001-02-28", "La Niña",
  "2001-03-01", "2002-05-31", "Neutral",
  "2002-06-01", "2003-02-28", "El Niño",
  "2003-03-01", "2004-06-30", "Neutral",
  "2004-07-01", "2005-02-28", "El Niño",
  "2005-03-01", "2005-10-31", "Neutral",
  "2005-11-01", "2006-03-31", "La Niña",
  "2006-04-01", "2006-08-31", "Neutral",
  "2006-09-01", "2007-01-31", "El Niño",
  "2007-02-01", "2007-05-31", "Neutral",
  "2007-06-01", "2008-06-30", "La Niña",
  "2008-07-01", "2008-10-31", "Neutral",
  "2008-11-01", "2009-03-31", "La Niña",
  "2009-04-01", "2009-06-30", "Neutral",
  "2009-07-01", "2010-03-31", "El Niño",
  "2010-04-01", "2010-05-31", "Neutral",
  "2010-06-01", "2011-05-31", "La Niña",
  "2011-06-01", "2011-06-30", "Neutral",
  "2011-07-01", "2012-04-30", "La Niña",
  "2012-05-01", "2014-09-30", "Neutral",
  "2014-10-01", "2016-04-30", "El Niño",
  "2016-05-01", "2016-06-30", "Neutral",
  "2016-07-01", "2016-12-31", "La Niña",
  "2017-01-01", "2017-07-31", "Neutral",
  "2017-08-01", "2018-03-31", "La Niña",
  "2018-04-01", "2018-08-31", "Neutral",
  "2018-09-01", "2019-06-30", "El Niño",
  "2019-07-01", "2020-07-31", "Neutral",
  "2020-08-01", "2021-05-31", "La Niña",
  "2021-06-01", "2021-07-31", "Neutral",
  "2021-08-01", "2023-01-31", "La Niña",
  "2023-02-01", "2023-04-30", "Neutral",
  "2023-05-01", "2024-04-30", "El Niño",
  "2024-05-01", "2024-12-31", "Neutral"
) |>
  dplyr::mutate(`Start Month` = as.Date(`Start Month`, tz = 'Asia/Ho_Chi_Minh'),
                `Finish Month` = as.Date(`Finish Month`, tz = 'Asia/Ho_Chi_Minh'))
MonthDays_tbl <- 
   tibble::tibble(Month = month.abb, Days = c(31, 28.24, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31))

# Function to scale secondary axis
scale_function <- function(x, scale, shift){
  return ((x)*scale - shift)
}

# Function to scale secondary variable values
inv_scale_function <- function(x, scale, shift){
  return ((x + shift)/scale)
}

# Function to find the closest multiple of 5 that is not greater than x
nearest_multiple_of_5_down_function <- function(x) {
  return(floor(x / 5) * 5)
}

```

```{r}
#| label: Loading dataset
#| title: Retrieve historical weather data from the Open-Meteo API

prq_daily_filename <- paste0('data/meteo_daily_',  params$loc_code, '.zst.parquet')
prq_hourly_filename <- paste0('data/meteo_hourly_',  params$loc_code, '.zst.parquet')

# meteo_daily_df <- # obtain Weather history for Location over 1950
#   openmeteo::weather_history( # location = c('latitude' = 43.25, 'longitude' = 76.93),   # Almaty city
#                               location = params$loc_coordinats,
#                               start = params$Start_Dat,
#                               end = params$Finish_Date,
#                               daily = c("weather_code", "temperature_2m_max", "temperature_2m_min", "temperature_2m_mean", "apparent_temperature_max", "apparent_temperature_min", "apparent_temperature_mean", "sunrise", "sunset", "daylight_duration", "sunshine_duration", "precipitation_sum", "rain_sum", "snowfall_sum", "precipitation_hours", "wind_speed_10m_max", "wind_gusts_10m_max", "wind_direction_10m_dominant", "shortwave_radiation_sum", "et0_fao_evapotranspiration") ) # openmeteo::weather_variables()[['daily_history_vars']] )
# 
# meteo_hourly_df <- # obtain Weather history for Location over 1950
#   openmeteo::weather_history( # location = c('latitude' = 43.25, 'longitude' = 76.93),   # Almaty city
#                               location = params$loc_coordinats,
#                               start = params$Start_Dat,
#                               end = params$Finish_Date,
#                               hourly = c("temperature_2m", "relative_humidity_2m", "dew_point_2m", "apparent_temperature", "precipitation", "rain", "snowfall", "snow_depth", "weather_code", "pressure_msl", "cloud_cover", "et0_fao_evapotranspiration", "vapour_pressure_deficit", "wind_speed_10m", "wind_direction_10m", "wind_gusts_10m", "is_day", "sunshine_duration", "shortwave_radiation") )

if (exists('meteo_daily_df') == TRUE) {
  arrow::write_parquet( meteo_daily_df, prq_daily_filename, compression = 'zstd', compression_level = 6) 
} else {
  meteo_daily_df = arrow::read_parquet(file = prq_daily_filename)
}     # The End of if (exists('meteo_daily_df') == TRUE)

if (exists('meteo_hourly_df') == TRUE) {
  arrow::write_parquet( meteo_hourly_df, prq_hourly_filename, compression = 'zstd', compression_level = 6)
} else {
  meteo_hourly_df = arrow::read_parquet(file = prq_hourly_filename)
}     # The End of if (exists('meteo_hourly_df') == TRUE)

dur <- paste0( format(as.Date(params$Start_Date), '%b %Y'), ' - ', format(as.Date(params$Finish_Date), '%b %Y') )

remove(prq_daily_filename, prq_hourly_filename)

```

```{r}
#| label: Merge dataset
#| expandable: false

#### I. Merge Weather Dataset with WCO Codes Dictionary

meteo_tbl <- 
  dplyr::inner_join(
    x = meteo_daily_df,
    y = dplyr::mutate( meteo_hourly_df # Month = factor(lubridate::month(datetime), labels = month.abb)
                     , date = lubridate::as_date(datetime)
                     , cloud_cover = dplyr::if_else(hourly_cloud_cover >= 80, 3, 
                                                    dplyr::if_else(hourly_cloud_cover < 20, 1, 2)) ) |>
          dplyr::group_by(date) |> # Month, 
          # dplyr::summarise(dplyr::across(dplyr::one_of('hourly_temperature_2m', 'hourly_apparent_temperature'),
          #                      list(max = max, min = min, mean = mean), .names = "{.col}_{.fn}"), .groups = 'drop') |>
          #   dplyr::rename_with(~ gsub('^hourly_', 'daily_', .), dplyr::starts_with('hourly_'))
            dplyr::summarise( cloud_cover = dplyr::if_else( mean(cloud_cover) <= 1.3, 'Sunny',
                                                  dplyr::if_else( mean(cloud_cover) == 3, 'Overcast', 'Partly Cloudy'))
                            , daily_relative_humidity_2m_max = max(hourly_relative_humidity_2m, na.rm = TRUE)
                            , daily_relative_humidity_2m_min = min(hourly_relative_humidity_2m, na.rm = TRUE)
                            , daily_snow_depth_max = max(hourly_snow_depth, na.rm = TRUE) ),
    by = dplyr::join_by( date == date )
  ) |>
    dplyr::left_join( y = WCO_Codes_tbl
                    , by = c('daily_weather_code' = 'weather_code'), relationship = 'many-to-one' ) |> 
      dplyr::left_join( y = ONI_tbl, 
                       by = dplyr::join_by( dplyr::between(date, `Start Month`, `Finish Month`)),
                       relationship = 'many-to-many') |>
        dplyr::select( -tidyselect::ends_with(' Month') ) |>
    dplyr::mutate(Month = factor(lubridate::month(date), labels = month.abb))

# remove(meteo_hourly_df, meteo_daily_df, WCO_Codes_tbl, ONI_tbl)

```

## Row - <i class="bi bi-calendar-range"></i> Value boxes {height="20%"}

```{r}
#| content: valuebox
#| label: Years
#| title: !expr "dur"
#| subtitle: !expr "paste('Duration of observation:', format(as.Date(params$Start_Date), '%b %Y'), '---', format(as.Date(params$Finish_Date), '%b %Y'))"

# Value Boxes with Icons - https://icons.getbootstrap.com/

list(
  icon = 'calendar-range',
  color = '#eed5b7',
  value = lubridate::interval(lubridate::ymd(params$Start_Date), lubridate::ymd(params$Finish_Date)) |>
    lubridate::as.duration() |> as.integer('year')  |> paste('Years')
    )
```

```{r}
#| content: valuebox
#| label: Mean Annual Temperature
#| title: Mean Annual Temperature

list(
  icon = 'thermometer-sun',
  color = 'success',
  value = round( mean(meteo_tbl$daily_temperature_2m_mean, na.rm = TRUE), digi = 1 ) |> paste0('°C')
    )
```

```{r}
#| content: valuebox
#| label: Average Annual Precipitation
#| title: Average Annual Precipitation

list(
  icon = 'cloud-rain',
  color = 'blue',
  value = format( round(mean(meteo_tbl$daily_precipitation_sum, na.rm = TRUE) * 365.24, digi = 0), big.mark = ' ') |> paste('mm')
   )
```

```{r}
#| content: valuebox
#| label: Mean Number of Days per Year without Precipitation
#| title: Mean Days w/o Precipitation in Year
#| fill: false

list(
  icon = 'sun',
  color = '#fffacd',
  value = round(meteo_tbl |> dplyr::filter(daily_precipitation_sum == 0) |> nrow() / nrow(meteo_tbl) * 365.24) |> paste('Days')
   )
```

## Row - Charts {height="80%"}

### Sidebar - Load Dataset from OpenMeteo (Daily Weather Variables) {.card-sidebar width="16%"}

#### Daily Parameter Definition

<small>

Historical data can be downloaded directly using the package [{openmeteo}](https://tpisel.r-universe.dev/openmeteo) from [**Open-Meteo API**](https://open-meteo.com/en/docs), since it has the ability to take the following **daily** variables:

| Variable | Unit | Description |
|:--------:|:----:|:------------|
| **weather_code** | WMO code | The most severe weather condition on a given day |
| **temperature_2m_max temperature_2m_min** | °C (°F) | Maximum and minimum daily air temperature at 2 meters above ground |
| **apparent_temperature_max apparent_temperature_min** | °C (°F) | Maximum and minimum daily apparent temperature |
| **precipitation_sum** | mm | Sum of daily precipitation (including rain, showers and snowfall) |
| **rain_sum** | mm | Sum of daily rain |
| **snowfall_sum** | cm | Sum of daily snowfall |
| **precipitation_hours** | hours | The number of hours with rain |
| **sunrise sunset** | iso8601 | Sun rise and set times |
| **sunshine_duration** | seconds | The number of seconds of sunshine per day is determined by calculating direct normalized irradiance exceeding 120 W/m², following the WMO definition. Sunshine duration will consistently be less than daylight duration due to dawn and dusk. |
| **daylight_duration** | seconds | Number of seconds of daylight per day |
| **wind_speed_10m_max wind_gusts_10m_max** | km/h (mph, m/s, knots) | Maximum wind speed and gusts on a day |
| **wind_direction_10m_dominant** | ° | Dominant wind direction |
| **shortwave_radiation_sum** | MJ/m² | The sum of solar radiaion on a given day in Megajoules |
| **et0_fao_evapotranspiration** | mm | Daily sum of ET₀ Reference Evapotranspiration of a well watered grass field |

</small>

### Column - Overview Conditions {width="42%"}

```{r}
#| label: Overview Air Temperature & Precipitation Chart
#| fig-asp: !expr "ifelse(interactive() == TRUE, 1, 0.4)"

# Функция для создания графика по среднемесячным температурам воздуха и выпадению осадкам
Union_plot <- function(data, from = min(data$date, na.rm = TRUE), to = max(data$date, na.rm = TRUE)) {
  data <- 
    data |> 
      dplyr::filter(date >= from & date <= to) |>

    # Среднемесячная максимальная, средняя и минимальная температура воздуха
        dplyr::group_by(Month) |>
          dplyr::summarise( high_month = base::max(daily_temperature_2m_max, na.rm = TRUE),
                            max_day   = base::max(daily_temperature_2m_mean, na.rm = TRUE),
                            avg_max_day   = base::mean(daily_temperature_2m_max, na.rm = TRUE),
                            median = stats::median(daily_temperature_2m_mean, na.rm = TRUE),
                            avg_min_day   = base::mean(daily_temperature_2m_min, na.rm = TRUE),
                            min_day  = base::min(daily_temperature_2m_mean, na.rm = TRUE),
                            low_month = base::min(daily_temperature_2m_min, na.rm = TRUE), .groups = 'drop' ) |>
    
    # Среднемесячное количество атмосферных осадков
      dplyr::full_join( y = data |>
        dplyr::mutate( period = sprintf("%2.0f-%02.0f", lubridate::year(date) - 2000, lubridate::month(date)) ) |>
          dplyr::group_by(period) |>
            dplyr::summarise( Month = dplyr::first(Month),
                              precipitation_sum = sum(daily_precipitation_sum, na.rm = TRUE), .groups = 'drop' ) |>
              dplyr::group_by(Month) |>
                dplyr::summarise( Precipitation = mean(precipitation_sum, na.rm = TRUE), .groups = 'drop' ),
        by = dplyr::join_by( Month == Month) )

  legend_labels <- c(
    high_month = "Maximum of the \nhighest temperature",
    max_day = "Maximum of Mean \nDaily temperature",
    avg_max_day = "Average of \nDaily temperature \nMaximum",
    median = "Median of Mean \nDaily temperature",
    avg_min_day = "Average of \nDaily temperature \nMinimum",
    min_day = "Minimum of Mean \nDaily temperature",
    low_month = "Minimum of the \nlowest temperature"
    )
  
  legend_colors <- c(high_month = 'red', max_day = 'red', avg_max_day = 'coral', median = 'coral', avg_min_day = 'blue', min_day = 'blueviolet', low_month = 'blueviolet')
  
  legend_shapes <- c(high_month = 24, max_day = 20, avg_max_day = 20, median = 19, avg_min_day = 20, min_day = 20, low_month = 25)
  
  # Automatically defining the scaling function for Two axes of Y - https://finchstudio.io/blog/ggplot-dual-y-axes/
  max_first  <- max(data$Precipitation, na.rm = TRUE) # Specify max of first y axis
  max_second <- max(data$high_month, na.rm = TRUE)    # Specify max of second y axis
  min_first  <- 0  # min(data$Precipitation, na.rm = TRUE)     # Specify min of first y axis
  min_second <- min(data$low_month, na.rm = TRUE) # Specify min of second y axis
  
  # scale and shift variables calculated based on desired mins and maxes
  scale = (max_second - min_second)/(max_first - min_first)
  shift = min_first - min_second
  
  data_long <- 
    data |>
      tidyr::pivot_longer( -c(Month, Precipitation), names_to = 'variable', values_to = 'value' ) |>
        dplyr::mutate(variable = factor(variable, levels = names(legend_labels)), Precipitation = NULL)
  
  ggplot2::ggplot( data = data_long ) +
    ggplot2::geom_col(data = data, aes(x = Month, y = Precipitation, fill = 'Precipitation')) +
    ggplot2::geom_text(data = data, aes(label = round(Precipitation, 0), x = Month, y = max(data$Precipitation) * 0.05), size = 3, color = 'cornflowerblue') +
    # ggplot2::geom_segment(data = data, aes(x = Month, xend = Month, y = inv_scale_function(low_month, scale, shift), yend = inv_scale_function(high_month, scale, shift)), linewidth = 1, color = 'gold', linetype = 'dashed') +
    ggplot2::geom_line( aes(x = Month, y = inv_scale_function(value, scale, shift), group = variable, color = variable, linetype = variable) ) +  
    ggplot2::geom_point( data = data_long |> dplyr::filter(variable %in% c('high_month', 'median', 'low_month'))
                       , aes(x = Month, y = inv_scale_function(value, scale, shift), 
                             color = variable, shape = variable) ) +
    ggplot2::geom_text(data = data, aes(label = round(median, 1), x = Month, y = inv_scale_function(median, scale, shift)), size = 3, nudge_x = -0.3, nudge_y = 9, color = 'coral') +
    
    ggplot2::scale_fill_manual( values = c(Precipitation = '#a9c4f5'), labels=c(Precipitation = 'Precipitation, mm') ) +
    ggplot2::scale_color_manual( values = legend_colors, labels = legend_labels ) +
    # ggplot2::scale_fill_manual( values = legend_colors, labels = legend_labels ) +
    ggplot2::scale_shape_manual( values = legend_shapes, labels = legend_labels ) +
    # ggplot2::scale_linewidth_manual( values = c(high_month = 0.5, max_day = 0.1, avg_max_day = 1, median = 2, avg_min_day = 1, min_day = 0.1, low_month = 0.5), labels = legend_labels ) +
    ggplot2::scale_linetype_manual( values = c(high_month = 'blank', max_day = 'dashed', avg_max_day = 'longdash', median = 'solid', avg_min_day = 'longdash', min_day = 'dashed', low_month = 'blank'), labels = legend_labels ) +
    ggplot2::scale_y_continuous( name = 'Average Month Precipitation, mm', limits = c(min_first, max_first), breaks = seq(0, 2000, by = ifelse(max_first - min_first > 200, 50, 25)), sec.axis = ggplot2::sec_axis( transform = ~scale_function(., scale, shift), breaks = seq(-40, 40, by = ifelse(max_second - min_second > 30, 5, 2)), name = 'Air Temperature, °C') ) +
    
    ggplot2::labs(title = 'Monthly Air Temperatures and Precipitation') + # , color = 'Color', fill = 'Fill', shape = 'Shape', linetype = 'Line Type') +
    ggplot2::theme_minimal() +
    # ggplot2::coord_cartesian(ylim = c(15, NA)) +
    ggplot2::theme( plot.title = ggplot2::element_text(hjust = 0.5),
                    legend.position = 'right', legend.text = element_text(size = 7),
                    legend.title = element_text(size = 8), 
                    axis.title.x = ggplot2::element_blank(),
                    axis.text.x = ggplot2::element_text(size = 7, vjust = 0.5),
                    axis.title.y = ggplot2::element_text(size = 9.5, color = 'cornflowerblue'),
                    axis.text.y = ggplot2::element_text(size = 7, vjust = 0.5, hjust = 1, color = 'cornflowerblue'),
                    axis.title.y.right = ggplot2::element_text(size = 9.5, color = 'coral'),
                    axis.text.y.right = ggplot2::element_text(size = 7, vjust = 0.5, hjust = 1, color = 'coral') ) +
    ggplot2::guides( fill = ggplot2::guide_legend(title = NULL), 
              color = ggplot2::guide_legend(title = 'Air Temperature, °C', override.aes = list(shape = legend_shapes)), 
                     shape = 'none', 
                     linetype = ggplot2::guide_legend(title = 'Air Temperature, °C') )

}    # The End of function `Union_plot()`

# Пример использования функции
Union_plot(data = meteo_tbl) # , from = as.Date(params$Start_Date), to = as.Date(params$Finish_Date)

```

### Column - Maximum Temperatures {width="42%"}

```{r}
#| label: Distribution of Maximum Temperatures by Day
#| fig-asp: !expr "ifelse(interactive() == TRUE, 1, 0.4)"

# Функция создания графика Распределение Переменной по дням Месяцев
MonthDistribution_plot <- function(data, from = min(data$date, na.rm = TRUE), to = max(data$date, na.rm = TRUE), 
                                   Col = 'daily_et0_fao_evapotranspiration', Mean_Col = 'daily_temperature_2m_max',
                                   Title = 'Evapotranspiration of a well watered Grass Field & Mean by Months',
                                   Bin_name = 'Evapotranspiration\nBins, mm',
                                   Mean_name = 'Evapotranspiration \nMean, mm',
                                   Bin_breaks = c(0, 0.001, 0.25, 0.5, 1, 2, 5, 10, Inf),
                                   Bin_labels = c("0", "0-0.25", "0.25-0.5", "0.5-1", "1-2", "2-5", "5-10", "more 10")|>
                                     setNames( c("[0,0.001)", "[0.001,0.25)", "[0.25,0.5)", "[0.5,1)", "[1,2)", "[2,5)", "[5,10)", "[10, Inf)") ),
                                   Bin_colors = grDevices::colorRampPalette(c('azure', "darkgoldenrod1", "darkgoldenrod2", "darkgoldenrod3", "darkgoldenrod" ))(8),
                                   Mean_color = 'darkgoldenrod4', Second_Y_Axes_name = 'mm',
                                   Is_Scaled_Second_Y_Axes = FALSE) {
  data <- 
    data |>
    dplyr::filter(date >= from & date <= to)
  
  data0 <- data
  
  data <- if (Col == 'cloud_cover') 
    # Группы по Ясным, Облачным и Пасмурным дням по дням Месяцев
    janitor::tabyl(data0, Month, !!rlang::sym(Col)) else {
      # Группы по Градациям Переменной по дням Месяцев
    dplyr::mutate(data0, Bin = factor(base::cut(!!rlang::sym(Col), breaks = Bin_breaks, right = FALSE)) ) |>
      janitor::tabyl(Month, Bin)
  }  # The End of if (Col == 'cloud_cover') 
  
  data <-
    data |> 
      janitor::adorn_percentages(denominator = 'row') |>
        janitor::untabyl() |>
    dplyr::left_join(MonthDays_tbl, by = dplyr::join_by(Month == Month)) |>
      dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ . * Days)) |>
        dplyr::select(-Days) 
  
  if (Mean_Col == 'daily_temperature_2m_max') y <- 
    # Среднемесячное число дней  заморозки
    dplyr::mutate(data0, Freezing_Days = dplyr::if_else(!!rlang::sym(Mean_Col) < 0, 1, 0) ) |>
      dplyr::group_by(Month) |> 
        dplyr::summarise(Mean = mean(Freezing_Days, na.rm = TRUE )) |>
    dplyr::left_join(MonthDays_tbl, by = dplyr::join_by(Month == Month)) |>
      dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ . * Days)) |>
        dplyr::select(-Days)
  #  The End of if (Mean_Col == 'daily_temperature_2m_max')
  
  if (Mean_Col == 'daily_precipitation_sum') y <- 
    # Среднемесячное количество Дней выпадения атмосферных осадков
    dplyr::left_join( x = dplyr::group_by(data0, Month) |> dplyr::count(name = 'All_Days')
                    , y = dplyr::filter(data0, !!rlang::sym(Mean_Col) > 0) |>
                      dplyr::group_by(Month) |> 
                      dplyr::count(name = 'Precipitation_Days')
                    , by = dplyr::join_by(Month == Month) ) |>
      dplyr::transmute(Month, Precipitation_Days_Share = Precipitation_Days / All_Days) |>
        dplyr::inner_join( MonthDays_tbl, by = dplyr::join_by(Month == Month) )|>
          dplyr::transmute(Month, Mean = Precipitation_Days_Share * Days)
  #  The End of if (Mean_Col == 'daily_precipitation_sum')
  
  if (Mean_Col != 'daily_temperature_2m_max' & Mean_Col != 'daily_precipitation_sum') y <- 
    # Среднедневная величина Переменной (Обобщенный Случай)
    dplyr::group_by(data0, Month) |> 
      dplyr::summarise(Mean = mean(!!rlang::sym(Mean_Col), na.rm = TRUE))
  #  The End of if (Mean_Col != 'daily_temperature_2m_max' & Mean_Col != 'cloud_cover')
  
  data <- 
    dplyr::inner_join( x = data, y = y, by = dplyr::join_by(Month == Month) )
  
  data_long <- 
    tidyr::pivot_longer( data,
                         cols = -c(Month, Mean),
                         names_to = 'Bin',
                         values_to = 'value' ) |>
    dplyr::mutate( Month = factor(Month, levels = month.abb)
                 , Mean = if (Mean_Col == 'daily_temperature_2m_max') dplyr::if_else(Mean == 0, NA, Mean) else Mean
                 , Bin = if (Col == 'cloud_cover') factor(Bin, levels = names(data)[c(-1, -ncol(data))]) else { 
                                              factor(Bin, levels = rev(names(data)[c(-1, -ncol(data))]),
                                                          labels = Bin_labels[ rev(names(data)[c(-1, -ncol(data))]) ]) }
                  #  The End of if (Col == 'cloud_cover') 
                 )
  
  # Automatically defining the scaling function for Two axes of Y - https://finchstudio.io/blog/ggplot-dual-y-axes/
  max_first  <- ifelse(Col %in% c('daily_relative_humidity_2m_max', 'daily_relative_humidity_2m_min', 'daily_wind_speed_10m_max'), 31, max(data_long$value, na.rm = TRUE)) # Specify max of first y axis
  max_second <- max(data$Mean, na.rm = TRUE)                           # Specify max of second y axis
  min_first  <- 0  # min(data_long$value, na.rm = TRUE)                # Specify min of first y axis
  min_second <- ifelse(Col %in% c('daily_relative_humidity_2m_max', 'daily_relative_humidity_2m_min', 'daily_wind_speed_10m_max'),  nearest_multiple_of_5_down_function(min(data$Mean, na.rm = TRUE)), 0) # Specify min of second y axis
  
  # scale and shift variables calculated based on desired mins and maxes
  scale = (max_second - min_second)/(max_first - min_first)
  shift = min_first - min_second
  
  NCol <- ifelse(names(data) |> length() > 10, 2L, 1L)  # Кол-во колонок при выводе легенды
  
  if (Col != 'cloud_cover') Bin_colors <- setNames(Bin_colors, Bin_labels)
  
  # Построение сводной столбиковой диаграммы с наложением
  p <- ggplot2::ggplot(data_long, aes(x = Month, y = value, fill = Bin)) +
    ggplot2::geom_col(color = 'white') +
    ggplot2::geom_line(data = dplyr::distinct(data_long, Month, Mean, .keep_all = TRUE), aes(x = Month, y = { if (Is_Scaled_Second_Y_Axes == TRUE) inv_scale_function(Mean, scale, shift) else Mean }, color = 'Mean'), group = 1, linewidth = 0.7) +
    ggplot2::geom_text(data = dplyr::distinct(data_long, Month, Mean, .keep_all = TRUE), 
                       aes(label = round(Mean, 1), x = Month, y = { if (Is_Scaled_Second_Y_Axes == TRUE) inv_scale_function(Mean, scale, shift) + 1.5 else Mean + 1.5 }), 
                       size = 3, color = Mean_color) +
    
    ggplot2::scale_fill_manual( values = Bin_colors, labels = Bin_labels, name = Bin_name ) +
    ggplot2::scale_color_manual( values = c(Mean = Mean_color), labels = c(Mean = Mean_name) ) +
    ggplot2::scale_y_continuous( name = 'Days', minor_breaks  = seq(0, 31, by = 1), 
                                 sec.axis = ggplot2::sec_axis(transform = 
                                { if (Is_Scaled_Second_Y_Axes == TRUE) ~scale_function(., scale, shift) else ~ . * 1 },
                                  name = Second_Y_Axes_name, 
                                  breaks = { if (Is_Scaled_Second_Y_Axes == TRUE) seq(0, ceiling( max(data$Mean) )
                                                  , by = ifelse(Col %in% c('daily_relative_humidity_2m_max', 'daily_relative_humidity_2m_min', 'daily_wind_speed_10m_max'), 5, 0.5) ) else seq(0, 24, by = 2) }) ) +
    
    ggplot2::labs(title = Title) + # , fill = 'Bin', color = 'Mean') +
    ggplot2::theme_minimal() +
    # ggplot2::coord_cartesian(ylim = c(15, NA)) +
    ggplot2::theme( plot.title = ggplot2::element_text(hjust = 0.5),
                    legend.position = 'right', legend.text = element_text(size = 7),
                    legend.title = element_text(size = 8), 
                    axis.title.x = ggplot2::element_blank(),
                    axis.text.x = ggplot2::element_text(size = 7, vjust = 0.5),
                    axis.title.y = ggplot2::element_text(size = 9.5, color = 'black'),
                    axis.text.y = ggplot2::element_text(size = 7, vjust = 0.5, hjust = 1, color = 'black'),
                    axis.title.y.right = ggplot2::element_text(size = 9.5, color = Mean_color),
                    axis.text.y.right = ggplot2::element_text(size = 7, vjust = 0.5, hjust=1, color = Mean_color)
    ) +
    ggplot2::guides( color = ggplot2::guide_legend(title = NULL, order = 1), 
                     fill = ggplot2::guide_legend(ncol = NCol) )
  
  return(p)
  
}    # The End of function `MonthDistribution_plot()`


# Диаграмма Распределения Максимальных температур по дням Месяцев
MonthDistribution_plot(data = meteo_tbl, # , from = as.Date(params$Start_Date), to = as.Date(params$Finish_Date)
                       Col = 'daily_temperature_2m_max', Mean_Col = 'daily_temperature_2m_max',
                       Title = 'Maximum Temperatures & Freezing Days by Months',
                       Bin_name = 'Temperature Bins, °C',
                       Mean_name = 'Freezing \nDays',
                       Bin_breaks = c(-Inf, -70, -50, seq(-32, 40, by = 4), 46, Inf),
                       Bin_labels = c("less -70", "-70/-50", "-50/-32", "-32/-28", "-28/-24", "-24/-20", "-20/-16", "-16/-12", "-12/-8", "-8/-4", "-4/0", "0/4", "4/8", "8/12", "12/16", "16/20", "20/24", "24/28", "28/32", "32/36", "36/40", "40/46", "more 46") |>
      setNames( c("[-Inf,-70)", "[-70,-50)", "[-50,-32)", "[-32,-28)", "[-28,-24)", "[-24,-20)", "[-20,-16)", "[-16,-12)", "[-12,-8)", "[-8,-4)", "[-4,0)", "[0,4)", "[4,8)", "[8,12)", "[12,16)", "[16,20)", "[20,24)", "[24,28)", "[28,32)", "[32,36)", "[36,40)", "[40,46)", "[46, Inf)") ),
                       Bin_colors = c("#9400D3", "#6400B8", "#35009D", "#050083", "#13248E", "#294D9F", "#4077AF", "#3594BA", "#1EABC2", "#08C3CA", "#00F7F7", "#00FF84", "#00FF33", "#1EFA00", "#70ED00", "#C1E000", "#FFCF06", "#FFB31F", "#FF9739", "#FA7A50", "#D55450", "#B02F50", "#8B0A50"),
                       Mean_color = 'steelblue4', Second_Y_Axes_name = 'Days')

```

# Precipitation & Relative Humidity

## Row - Charts {height="100%"}

### Column - Precipitation {width="50%"}

```{r}
#| label: Cloudy, Sunny and Precipitation Days Chart
#| fig-asp: !expr "ifelse(interactive() == TRUE, 1, 0.4)"

# Диаграмма Распределения когда было Облачно, Солнечно и Дням осадков
MonthDistribution_plot(data = meteo_tbl, # , from = as.Date(params$Start_Date), to = as.Date(params$Finish_Date)
                       Col = 'cloud_cover', Mean_Col = 'daily_precipitation_sum',
                       Title = 'Cloudiness & Precipitation Days by Months',
                       Bin_name = 'Cloudiness by \nMonths, Days',
                       Mean_name = 'Precipitation \nDays',
                       Bin_breaks = NULL,
                       Bin_labels = c(Sunny = 'Sunny', `Partly Cloudy` = 'Partly Cloudy', Overcast = 'Overcast'),
                       Bin_colors = c(Sunny = 'yellow', `Partly Cloudy` = '#D8D594', Overcast = 'lightskyblue4'),
                       Mean_color = 'cornflowerblue', Second_Y_Axes_name = 'Days')

```

```{r}
#| label: Distribution of Precipitation Amount by Day Chart
#| fig-asp: !expr "ifelse(interactive() == TRUE, 1, 0.4)"

# Диаграмма Распределения Количества Осадков по дням Месяцев 
MonthDistribution_plot(data = meteo_tbl, # , from = as.Date(params$Start_Date), to = as.Date(params$Finish_Date)
                       Col = 'daily_precipitation_sum', Mean_Col = 'daily_precipitation_hours',
                       Title = 'Daily Precipitation Amount & Precipitation Hours by Months',
                       Bin_name = 'Daily Precipitation \nBins, mm',
                       Mean_name = 'Daily Precipitation, \nHours',
                       Bin_breaks = c(-Inf, 0.1, 2, 5, 10, 20, 50, 100, Inf),
                       Bin_labels = c("Dry Days", "0-2", "2-5", "5-10", "10-20", "20-50", "50-100", "more 100") |>
    setNames( c("[-Inf,0.1)", "[0.1,2)", "[2,5)", "[5,10)", "[10,20)", "[20,50)", "[50,100)", "[100, Inf)") ),
                       Bin_colors = grDevices::colorRampPalette(c("#E4E075", "cadetblue1", "cornflowerblue", "blue" ))(12)[-c(2:5)],
                       Mean_color = 'blue', Second_Y_Axes_name = 'Hours')

```

### Column - Relative Humidity {width="50%"}

```{r}
#| label: Distribution of Maximum Relative Humidity by Day Chart
#| fig-asp: !expr "ifelse(interactive() == TRUE, 1, 0.4)"

# Диаграмма Распределения Максимальной Относительной Влажности по дням Месяцев
MonthDistribution_plot(data = meteo_tbl, # , from = as.Date(params$Start_Date), to = as.Date(params$Finish_Date)
                       Col = 'daily_relative_humidity_2m_max', Mean_Col = 'daily_relative_humidity_2m_max',
                       Title = 'Maximum Relative Humidity Days by Months',
                       Bin_name = 'Maximum Relative \nHumidity Bins, %',
                       Mean_name = 'Average Maximum \nRelative Humidity, %',
                       Bin_breaks = c(0, seq(10, 105, by = 5)),
                       Bin_labels = c("less 10", "10-15", "15-20", "20-25", "25-30", "30-35", "35-40", "40-45", "45-50", "50-55", "55-60", "60-65", "65-70", "70-75", "75-80", "80-85-", "85-90", "90-95", "95-99", "100") |>
      setNames( c("[0,10)", "[10,15)", "[15,20)", "[20,25)", "[25,30)", "[30,35)", "[35,40)", "[40,45)", "[45,50)", "[50,55)", "[55,60)", "[60,65)", "[65,70)", "[70,75)", "[75,80)", "[80,85)", "[85,90)", "[90,95)", "[95,100)", "[100,105)") ),
                       Bin_colors = grDevices::colorRampPalette(c("#ecf0fc", "#d9e1f9", "#c6d2f6", "#b3c3f3", "#a0b4f0", "#8da5ed", "#7a96ea", "#6687e7"))(20),
                       Mean_color = 'darkblue', Second_Y_Axes_name = 'Relative Humidity, %',
                       Is_Scaled_Second_Y_Axes = TRUE)

```

```{r}
#| label: Distribution of Minimum Relative Humidity by Day Chart
#| fig-asp: !expr "ifelse(interactive() == TRUE, 1, 0.4)"

# Диаграмма Распределения Минимальной Относительной Влажности по дням Месяцев
MonthDistribution_plot(data = meteo_tbl, # , from = as.Date(params$Start_Date), to = as.Date(params$Finish_Date)
                       Col = 'daily_relative_humidity_2m_min', Mean_Col = 'daily_relative_humidity_2m_min',
                       Title = 'Minimum Relative Humidity Days by Months',
                       Bin_name = 'Minimum Relative \nHumidity Bins, %',
                       Mean_name = 'Average Minimum \nRelative Humidity, %',
                       Bin_breaks = c(0, seq(10, 105, by = 5)),
                       Bin_labels = c("less 10", "10-15", "15-20", "20-25", "25-30", "30-35", "35-40", "40-45", "45-50", "50-55", "55-60", "60-65", "65-70", "70-75", "75-80", "80-85-", "85-90", "90-95", "95-99", "100") |>
      setNames( c("[0,10)", "[10,15)", "[15,20)", "[20,25)", "[25,30)", "[30,35)", "[35,40)", "[40,45)", "[45,50)", "[50,55)", "[55,60)", "[60,65)", "[65,70)", "[70,75)", "[75,80)", "[80,85)", "[85,90)", "[90,95)", "[95,100)", "[100,105)") ),
                       Bin_colors = grDevices::colorRampPalette(c("#ecf0fc", "#d9e1f9", "#c6d2f6", "#b3c3f3", "#a0b4f0", "#8da5ed", "#7a96ea", "#6687e7"))(20),
                       Mean_color = 'darkblue', Second_Y_Axes_name = 'Relative Humidity, %',
                       Is_Scaled_Second_Y_Axes = TRUE)

```

# Radiation & Winds

## Row - Charts {height="100%"}

### Column - Radiation {width="50%"}

```{r}
#| label: Distribution of Shortwave Radiation by Day Chart
#| fig-asp: !expr "ifelse(interactive() == TRUE, 1, 0.4)"

# Диаграмма Распределения Коротковолновой Солнечной Радиации по дням Месяцев
MonthDistribution_plot(data = meteo_tbl, # , from = as.Date(params$Start_Date), to = as.Date(params$Finish_Date)
                       Col = 'daily_shortwave_radiation_sum', Mean_Col = 'daily_shortwave_radiation_sum',
                       Title = 'Shortwave Radiation Amount & Mean by Months',
                       Bin_name = 'Shortwave \nRadiation\nBins, W/m²',
                       Mean_name = 'Shortwave \nRadiation\nMean, W/m²',
                       Bin_breaks = c(-Inf, 1, 2, 5, 10, 15, 20, 25, Inf),
                       Bin_labels = c("0-1", "1-2", "2-5", "5-10", "10-15", "15-20", "20-25", "more 25") |>
    setNames( c("[-Inf,1)", "[1,2)", "[2,5)", "[5,10)", "[10,15)", "[15,20)", "[20,25)", "[25, Inf)") ),
                        Bin_colors = grDevices::colorRampPalette(c('#fff1e1', "bisque", "#ff9d57", "chocolate1", "chocolate3" ))(8),
                        Mean_color = 'brown', Second_Y_Axes_name = 'W/m²')

```

```{r}
#| label: Distribution of Evapotranspiration by Day Chart
#| fig-asp: !expr "ifelse(interactive() == TRUE, 1, 0.4)"

# Функция создания графика Распределение эталонного испарения хорошо орошаемого травяного поля по ФАО по дням Месяцев
MonthDistribution_plot(data = meteo_tbl, # , from = as.Date(params$Start_Date), to = as.Date(params$Finish_Date)
                       Col = 'daily_et0_fao_evapotranspiration', Mean_Col = 'daily_et0_fao_evapotranspiration',
                       Title = 'Evapotranspiration of a well watered Grass Field & Mean by Months',
                       Bin_name = 'Evapotrans-\npiration\nBins, mm',
                       Mean_name = 'Evapotranspiration \nMean, mm',
                       Bin_breaks = c(0, 0.001, 0.25, 0.5, 1, 2, 5, 10, Inf),
                       Bin_labels = c("0", "0-0.25", "0.25-0.5", "0.5-1", "1-2", "2-5", "5-10", "more 10")|>
setNames( c("[0,0.001)", "[0.001,0.25)", "[0.25,0.5)", "[0.5,1)", "[1,2)", "[2,5)", "[5,10)", "[10,Inf)") ),
                        Bin_colors = grDevices::colorRampPalette(c('azure', '#eeffff', '#d5ffff', '#9EEFE7', '#8BECE2', "turquoise1"))(8),
                        Mean_color = 'darkgoldenrod4', Second_Y_Axes_name = 'mm',
                        Is_Scaled_Second_Y_Axes = TRUE)

```

### Column - Winds {width="50%"}

```{r}
#| label: Distribution of Speed Winds by Day Chart
#| fig-asp: !expr "ifelse(interactive() == TRUE, 1, 0.4)"

# Диаграмма Распределения Скорости ветра на уровни 10 м по дням Месяцев
MonthDistribution_plot(data = meteo_tbl, # , from = as.Date(params$Start_Date), to = as.Date(params$Finish_Date)
                       Col = 'daily_wind_speed_10m_max', Mean_Col = 'daily_wind_speed_10m_max',
                       Title = 'Maximum Wind Speed 10 Meters Days by Months',
                       Bin_name = 'Maximum Wind \nSpeed Bins, km/h',
                       Mean_name = 'Average Maximum \nWind Speed, km/h',
                       Bin_breaks = seq(0, 95, by = 5),
                       Bin_labels = c("0-5", "5-10", "10-15", "15-20", "20-25", "25-30", "30-35", "35-40", "40-45", "45-50", "50-55", "55-60", "60-65", "65-70", "70-75", "75-80", "80-85-", "85-90", "90-95") |>
      setNames( c("[0,5)", "[5,10)", "[10,15)", "[15,20)", "[20,25)", "[25,30)", "[30,35)", "[35,40)", "[40,45)", "[45,50)", "[50,55)", "[55,60)", "[60,65)", "[65,70)", "[70,75)", "[75,80)", "[80,85)", "[85,90)", "[90,95)") ),
                       Bin_colors = grDevices::colorRampPalette(c('chartreuse4', 'chartreuse3', 'chartreuse2', "chartreuse1", 'yellow', 'darkorange'))(20),
                       Mean_color = 'darkolivegreen', Second_Y_Axes_name = 'Maximum Wind Speed, km/h',
                       Is_Scaled_Second_Y_Axes = TRUE)

```

```{r}
#| label: Distribution of Wind Speed Rose by Day Chart
#| fig-asp: !expr "ifelse(interactive() == TRUE, 1, 0.4)"

# Диаграмма Распределения Скорости ветра на уровни 10 м по сторонам света
Wind_Speed_Rose_plot <-   function(data, from = min(data$date, na.rm = TRUE), to = max(data$date, na.rm = TRUE), 
                                   Col = 'daily_wind_direction_10m_dominant', Mean_Col = 'daily_wind_speed_10m_max',
                                   Title = 'Wind Speed Rose',
                                   Bin_name = 'Maximum Wind Speed Bins, km/h',
                                   Bin_breaks = seq(0, 105, by = 5),
                                   Bin_labels = c("0-5", "5-10", "10-15", "15-20", "20-25", "25-30", "30-35", "35-40", "40-45", "45-50", "50-55", "55-60", "60-65", "65-70", "70-75", "75-80", "80-85-", "85-90", "90-95", "95-100", "100-105") |>
                  setNames( c("[0,5)", "[5,10)", "[10,15)", "[15,20)", "[20,25)", "[25,30)", "[30,35)", "[35,40)", "[40,45)", "[45,50)", "[50,55)", "[55,60)", "[60,65)", "[65,70)", "[70,75)", "[75,80)", "[80,85)", "[85,90)", "[90,95)", "[95,100)", "[100-105)") ),
                                   Bin_colors = grDevices::colorRampPalette(c('chartreuse4', 'chartreuse3', 'chartreuse2', "chartreuse1", 'yellow', 'darkorange'))(21)) {
  
  Directions <-  c('NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW', 'N')
  
  data <- 
    data |>
      dplyr::filter(date >= from & date <= to) |>
  # Группы по Градациям Переменной по дням Месяцев
        dplyr::mutate( Bin = factor(base::cut(!!rlang::sym(Mean_Col), breaks = Bin_breaks, right = FALSE))
                     , Direction = factor( forcats::fct_collapse( cut(!!rlang::sym(Col), breaks = seq(-11.25, 360 + 11.25, by = 22.5), right = FALSE), N = c('[-11.2,11.2)', '[349,371)')), labels = Directions ) ) |>
    janitor::tabyl(Direction, Bin) 
  
  data_long <- 
    tidyr::pivot_longer( data,
                         cols = -c(Direction), 
                         names_to = 'Bin',
                         values_to = 'value' ) |>
    dplyr::mutate( Direction = factor(Direction, levels = Directions)
                 , Bin = factor(Bin, levels = rev(names(data)[-1]), 
                                labels = rev(Bin_labels[ names(data)[-1] ]) ) )
  
  NCol <- ifelse(names(data) |> length() > 10, 2L, 1L)  # Кол-во колонок при выводе легенды
  
  # Построение сводной столбиковой диаграммы с наложением
  ggplot2::ggplot(data_long, aes(x = Direction, y = value, fill = Bin)) +
    ggplot2::geom_col(color = 'white') +

    ggplot2::scale_fill_manual( values = Bin_colors, name = Bin_name ) +
    ggplot2::scale_y_continuous( labels = NULL ) +

    ggplot2::labs(title = Title, y = 'Days') + # , fill = 'Cloudiness', color = 'Precipitation Days') +
    ggplot2::theme_minimal() +
    # ggplot2::coord_cartesian(ylim = c(15, NA)) +
    ggplot2::coord_polar(theta = 'x', start = 11.25 * (pi / 180)) +
    ggplot2::theme( plot.title = ggplot2::element_text(hjust = 0.5),
                    legend.position = 'right', legend.text = element_text(size = 7),
                    legend.title = element_text(size = 8), 
                    axis.title.x = ggplot2::element_blank(),
                    axis.text.x = ggplot2::element_text(size = 7, vjust = 0.5)
                    )

}    # The End of function `Maximum_Relative_Humidity_plot()`

# Пример использования функции

Wind_Speed_Rose_plot(data = meteo_tbl, # from = min(data$date, na.rm = TRUE), to = max(data$date, na.rm = TRUE), 
                     Col = 'daily_wind_direction_10m_dominant', Mean_Col = 'daily_wind_speed_10m_max',
                     Title = 'Wind Speed Rose',
                     Bin_name = 'Maximum Wind Speed Bins, km/h',
                     Bin_breaks = seq(0, 105, by = 5),
                     Bin_labels = c("0-5", "5-10", "10-15", "15-20", "20-25", "25-30", "30-35", "35-40", "40-45", "45-50", "50-55", "55-60", "60-65", "65-70", "70-75", "75-80", "80-85-", "85-90", "90-95", "95-100", "100-105") |>
    setNames( c("[0,5)", "[5,10)", "[10,15)", "[15,20)", "[20,25)", "[25,30)", "[30,35)", "[35,40)", "[40,45)", "[45,50)", "[50,55)", "[55,60)", "[60,65)", "[65,70)", "[70,75)", "[75,80)", "[80,85)", "[85,90)", "[90,95)", "[95,100)", "[100-105)") ),
                     Bin_colors = grDevices::colorRampPalette(c('chartreuse4', 'chartreuse3', 'chartreuse2', "chartreuse1", 'yellow', 'darkorange'))(21))

```

# Data & Map {orientation="columns" scrolling="true"}

::: {.card title="Let's look at the tabular data" width="70%"}
Now let's take a closer look at the details of the data set.:

```{r}
#| label: Interaction Table

meteo_tbl |>
  dplyr::select(-Weather, -Conditions) |>
  DT::datatable(options = list(dom = 'ftip', paging = TRUE) )  # buttons = c('copy', 'csv', 'excel'), scrollX = TRUE,     fixedColumns = list(leftColumns = 2, rightColumns = 1), 

```
:::

:::: {.card title="Let's consider the location of a geographic object" width="30%"}
`{r} Subtitle` fits here:

```{r}
#| label: Interaction Map

leaflet::leaflet() |> 
  # leaflet::addTiles(group = "OSM (default)") |>
  # leaflet::addProviderTiles(providers$CartoDB.Positron, group = "Positron (minimal)") |>
  # leaflet::addProviderTiles(providers$Esri.WorldImagery, group = "World Imagery (satellite)") |>
  leaflet::addProviderTiles(providers$Stadia.StamenTerrain, group = "World Terrain (color)") |>
  leaflet::addMarkers(lng = params$loc_coordinats['longitude'], lat = params$loc_coordinats['latitude'],
             popup = paste0(params$loc_name, ' (', params$loc_code, ')' )) |>
  leaflet::setView(lng = as.double(params$loc_coordinats['longitude']), 
                   lat = as.double(params$loc_coordinats['latitude']), zoom = 7)

# leaflet::leaflet() |>
#   leaflet::addTiles() |>
#   leaflet::addProviderTiles(providers$Stamen.Terrain) |>
#   leaflet::addMarkers(lng = params$loc_coordinats['longitude'], lat = params$loc_coordinats['latitude'], 
#              popup = paste0(params$loc_name, ' (', params$loc_code, ')' )) |>
#   leaflet::fitBounds(lng1 = params$loc_coordinats['longitude'] - 0.2, lat1 = params$loc_coordinats['latitude'] - 0.2,
#                      lng2 = params$loc_coordinats['longitude'] + 0.2, lat2 = params$loc_coordinats['latitude'] + 0.2)

```

::: {.callout-caution collapse="true"}
```{r}
#| label: The End of Session
#| title: 'What packages were used?'
#| comment: ''

# The End of Session

devtools::session_info()

Sys.time()

```
:::
::::
